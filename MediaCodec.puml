@startuml MediaCodec

hide footbox
skinparam {
    ' defaultFontName Abyssinica SIL
    Shadowing false
    backgroundColor white
    NoteFontColor #Black
    NoteFontSize 16
    NoteTextAlignment left
    NoteBackgroundColor WhiteSmoke
    NoteColor transparent
    NoteBorderThickness 0
    NoteBorderColor transparent
    NoteBorderThickness 0
    NoteShadowing false
    ParticipantPadding 0
    BoxPadding 20
    dpi 96
    ClassBackgroundColor transparent
    ClassHeaderBackgroundColor lightgreen
    ClassStereotypeFontColor transparent
    SequenceBoxBordercolor sienna
    SequenceBoxFontSize 24
    SequenceBoxFontColor Black
    SequenceBoxBackgroundColor WhiteSmoke
    SequenceLifeLineBackgroundColor WhiteSmoke
    SequenceMessageAlignment center
    SequenceGroupHeaderFontColor White
    SequenceGroupHeaderFontSize 20
    SequenceGroupBackgroundColor DarkOliveGreen
    SequenceGroupBodyBackgroundColor transparent
    SequenceGroupBorderThickness 4
    SequenceGroupBorderColor DarkOliveGreen
    ' transparent
    sequence {
        ParticipantBackgroundColor WhiteSmoke
        ParticipantBorderColor Gray
        ParticipantFontStyle Bold
        ParticipantFontSize 12
        ParticipantPadding 0

        LifeLineBorderColor DimGray
        ArrowColor Black
        ArrowThickness 0.8
        ColorArrowSeparationSpace 30
    }
}

box NuPlayer
participant GenericSource
participant Decoder
end box

box MediaCodec
participant MediaCodec
participant BufferCallback
end box

box CCodec
participant CCodecBufferChannel
participant CCodec
end box

box HIDL
participant ClientListener
participant HidlListener
participant Component
end box

->MediaCodec:**kWhatStart**
MediaCodec->Decoder:handleAnInputBuffer()
activate Decoder
Decoder->Decoder:onRequestInputBuffers()
note left:**DecoderBase**
activate Decoder
Decoder->Decoder:doRequestBuffers()
note left:**Decoder**
activate Decoder
Decoder->Decoder:Decoder::fetchInputData()
activate Decoder
Decoder->GenericSource:dequeueAccessUnit()
deactivate Decoder
Decoder->Decoder:onInputBufferFetched()
activate Decoder
Decoder->MediaCodec:**kWhatQueueInputBuffer**
deactivate Decoder
deactivate Decoder
deactivate Decoder
deactivate Decoder
deactivate Decoder
activate MediaCodec
MediaCodec->MediaCodec:onQueueInputBuffer()
activate MediaCodec
MediaCodec->CCodecBufferChannel:queueInputBuffer()
deactivate MediaCodec
deactivate MediaCodec
activate CCodecBufferChannel
CCodecBufferChannel->CCodecBufferChannel:queueInputBufferInternal()
activate CCodecBufferChannel
CCodecBufferChannel->Component:queue()
deactivate CCodecBufferChannel
deactivate CCodecBufferChannel





HidlListener<--Component:onInputBuffersReleased()
HidlListener->ClientListener:onInputBufferDone()
ClientListener->CCodec:onInputBufferDone()
CCodec->CCodecBufferChannel:onInputBufferDone()
activate CCodecBufferChannel
CCodecBufferChannel->CCodecBufferChannel:feedInputBufferIfAvailable()
activate CCodecBufferChannel
CCodecBufferChannel->CCodecBufferChannel:feedInputBufferIfAvailableInternal()
activate CCodecBufferChannel
CCodecBufferChannel->BufferCallback:onInputBufferAvailable()
deactivate CCodecBufferChannel
deactivate CCodecBufferChannel
deactivate CCodecBufferChannel

BufferCallback->MediaCodec:**kWhatFillThisBuffer**
activate MediaCodec
MediaCodec->MediaCodec:onInputBufferAvailable()
activate MediaCodec
MediaCodec->MediaCodec:dequeuePortBuffer()
activate MediaCodec
MediaCodec->Decoder:**CB_INPUT_AVAILABLE**
deactivate MediaCodec
deactivate MediaCodec
deactivate MediaCodec
activate Decoder
Decoder->Decoder:handleAnInputBuffer()
activate Decoder
Decoder->Decoder:onRequestInputBuffers()
note left:**DecoderBase**
activate Decoder
Decoder->Decoder:doRequestBuffers()
note left:**Decoder**
activate Decoder
Decoder->Decoder:Decoder::fetchInputData()
activate Decoder
Decoder->GenericSource:dequeueAccessUnit()
deactivate Decoder
Decoder->Decoder:onInputBufferFetched()
activate Decoder
Decoder->MediaCodec:**kWhatQueueInputBuffer**
deactivate Decoder
deactivate Decoder
deactivate Decoder
deactivate Decoder
deactivate Decoder
activate MediaCodec
MediaCodec->MediaCodec:onQueueInputBuffer()
activate MediaCodec
MediaCodec->CCodecBufferChannel:queueInputBuffer()
deactivate MediaCodec
deactivate MediaCodec
activate CCodecBufferChannel
CCodecBufferChannel->CCodecBufferChannel:queueInputBufferInternal()
activate CCodecBufferChannel
CCodecBufferChannel->Component:queue()
deactivate CCodecBufferChannel
deactivate CCodecBufferChannel

HidlListener<--Component:onWorkDone()
HidlListener->ClientListener:onWorkDone()
ClientListener->CCodec:**kWhatWorkDone**
CCodec->CCodecBufferChannel:onWorkDone()
activate CCodecBufferChannel
CCodecBufferChannel->CCodecBufferChannel:handleWork()
activate CCodecBufferChannel
CCodecBufferChannel->CCodecBufferChannel:sendOutputBuffers()
activate CCodecBufferChannel
CCodecBufferChannel->BufferCallback:onOutputBufferAvailable()
deactivate CCodecBufferChannel
deactivate CCodecBufferChannel
deactivate CCodecBufferChannel
BufferCallback->MediaCodec:**kWhatDrainThisBuffer**
activate MediaCodec
MediaCodec->MediaCodec:onOutputBufferAvailable()
activate MediaCodec
MediaCodec->MediaCodec:dequeuePortBuffer()
activate MediaCodec
MediaCodec->Decoder:CB_OUTPUT_AVAILABLE()
deactivate MediaCodec
deactivate MediaCodec
deactivate MediaCodec
activate Decoder
Decoder->Decoder:handleAnOutputBuffer()
activate Decoder
Decoder->Decoder:**kWhatRenderBuffer**
activate Decoder
Decoder->Decoder:onRenderBuffer()
activate Decoder
Decoder->MediaCodec::**kWhatReleaseOutputBuffer**
deactivate Decoder
deactivate Decoder
deactivate Decoder
deactivate Decoder
activate MediaCodec
MediaCodec->MediaCodec:onReleaseOutputBuffer()
activate MediaCodec
MediaCodec->CCodecBufferChannel:renderOutputBuffer()
deactivate MediaCodec
deactivate MediaCodec
CCodecBufferChannel->Component:queueToOutputSurface()

@enduml