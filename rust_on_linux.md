# Rust on Linux(ubuntu) call c static lib via FFI

## 前提
假设已经在 PC 上安装了基础的 rust 环境  
本文所讲与 Android 流程不同, 请不要混淆

## 准备工作
在 macOS 上需要安装 bindgen:
```shell
brew install bindgen
```

## 首先准备一个基础项目:
``` shell
cargo new json_lrn
cd json_lrn
```

建立 C 库源码文件`src/json_lrn.c`:
```c
#include <stdio.h>
#include <string.h>
#include <stdlib.h>

void say_hello(const char *buf){
    long name_len = *(const long *)buf;
    char *str = (char *)malloc(name_len + 1);
    memset(str, 0x0, name_len);
    memcpy(str, buf + 8, name_len);

    int age = *(int *)(buf + sizeof(long) + name_len);
    printf("libjsonlrn: Name: %s, Age: %d\n", str, age);
}
```

建立头文件`src/person.h`:
```c
#ifndef __PERSION__
#define __PERSION__

struct Person {
    const char *name;
    int age;
};

extern void say_hello(const unsigned char *buf);

#endif
```

调用`bindgen`产生 FFI 接口文件:
```shell
bindgen -o src/person_binding.rs --allowlist-function say_hello src/person.h
```

此时生成的 `src/person_binding.rs`:
```rust
/* automatically generated by rust-bindgen 0.65.1 */

extern "C" {
    pub fn say_hello(buf: *const ::std::os::raw::c_uchar);
}
```

编写 `CMakeLists.txt`:
```cmake
cmake_minimum_required(VERSION 3.0.0)
project(jsonlrn VERSION 0.1.0 LANGUAGES C)

add_library(jsonlrn src/json_lrn.c)
```

编译产生库文件:
```shell
mdkir build

pushd build

cmake ..
-- The C compiler identification is AppleClang 14.0.3.14030022
-- Detecting C compiler ABI info
-- Detecting C compiler ABI info - done
-- Check for working C compiler: /Library/Developer/CommandLineTools/usr/bin/cc - skipped
-- Detecting C compile features
-- Detecting C compile features - done
-- Configuring done
-- Generating done
-- Build files have been written to: /opt/coding/rust/json_lrn/build

make
[ 50%] Building C object CMakeFiles/jsonlrn.dir/src/json_lrn.c.o
[100%] Linking C static library libjsonlrn.a
[100%] Built target jsonlrn

popd
```

编写 `Cargo.toml`:
```toml
[package]
name = "json_lrn"
version = "0.1.0"
edition = "2021"
build = "src/build.rs"

# See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html

[dependencies]
bincode = "1.3.3"
byteorder = "1.4.3"
libc = "0.2.147"
serde = { version = "1.0.185", features = ["derive"] }
serde_derive = "1.0.185"
serde_json = "1.0.105"

[build_dependencies]
dunce = "1.0.4"
```

其中:
* `[build_dependencies]` 是 `src/build.rs` 的依赖
* `[dependencies]` 是 `src/main.rs` 的依赖

这里特别注意`build = "src/build.rs"`, 链接到 C 库的配置将在该文件生成, 因此编写文件`src/build.rs`
```rust
extern crate dunce;
use std::{env, path::PathBuf};

fn main() {
    let root: PathBuf = PathBuf::from(env::var_os("CARGO_MANIFEST_DIR").unwrap());
    let library_dir = dunce::canonicalize(root.join("build/")).unwrap();
    println!("cargo:rustc-link-lib=static={}", "jsonlrn");
    println!("cargo:rustc-link-search=native={}", env::join_paths(&[library_dir]).unwrap().to_str().unwrap());
}
```

编写源码 `src/main.rs`:
```rust
use serde::{Serialize, Deserialize};

mod ffi {
    include!("person_binding.rs");
}

#[derive(Serialize, Deserialize, Debug)]
struct Person {
    name: String,
    age: u32,
}

fn main() {
    let person = Person {
        name: "Alice".to_string(),
        age: 30,
    };

    let json_str = serde_json::to_string(&person).expect("Serialization failed");
    println!("Serialized JSON: {}", json_str);

    let json_string = r#"{ "name": "Bob", "age": 25 }"#;
    let person: Person = serde_json::from_str(json_string).expect("Deserialization failed");
    println!("main.rs: Name: {}, Age: {}", person.name, person.age);

    let serialized_data: Vec<u8> = bincode::serialize(&person).expect("Serialization failed");
    println!("Serialized data: {:?}", serialized_data);

    unsafe {
        ffi::say_hello(serialized_data.as_ptr());
    }
}
```

然后执行命令编译运行 rust 项目:
```shell
cargo run
   Compiling json_lrn v0.1.0 (/opt/coding/rust/json_lrn)
    Finished dev [unoptimized + debuginfo] target(s) in 0.35s
     Running `target/debug/json_lrn`
Serialized JSON: {"name":"Alice","age":30}
main.rs: Name: Bob, Age: 25
Serialized data: [3, 0, 0, 0, 0, 0, 0, 0, 66, 111, 98, 25, 0, 0, 0]
libjsonlrn: Name: Bob, Age: 25
```