<!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <title>Android NFC</title>
        <style>
/* From extension vscode.github */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

.vscode-dark img[src$=\#gh-light-mode-only],
.vscode-light img[src$=\#gh-dark-mode-only] {
	display: none;
}

/* From extension vscode.markdown-math */
@font-face{font-family:KaTeX_AMS;font-style:normal;font-weight:400;src:url(fonts/KaTeX_AMS-Regular.woff2) format("woff2"),url(fonts/KaTeX_AMS-Regular.woff) format("woff"),url(fonts/KaTeX_AMS-Regular.ttf) format("truetype")}@font-face{font-family:KaTeX_Caligraphic;font-style:normal;font-weight:700;src:url(fonts/KaTeX_Caligraphic-Bold.woff2) format("woff2"),url(fonts/KaTeX_Caligraphic-Bold.woff) format("woff"),url(fonts/KaTeX_Caligraphic-Bold.ttf) format("truetype")}@font-face{font-family:KaTeX_Caligraphic;font-style:normal;font-weight:400;src:url(fonts/KaTeX_Caligraphic-Regular.woff2) format("woff2"),url(fonts/KaTeX_Caligraphic-Regular.woff) format("woff"),url(fonts/KaTeX_Caligraphic-Regular.ttf) format("truetype")}@font-face{font-family:KaTeX_Fraktur;font-style:normal;font-weight:700;src:url(fonts/KaTeX_Fraktur-Bold.woff2) format("woff2"),url(fonts/KaTeX_Fraktur-Bold.woff) format("woff"),url(fonts/KaTeX_Fraktur-Bold.ttf) format("truetype")}@font-face{font-family:KaTeX_Fraktur;font-style:normal;font-weight:400;src:url(fonts/KaTeX_Fraktur-Regular.woff2) format("woff2"),url(fonts/KaTeX_Fraktur-Regular.woff) format("woff"),url(fonts/KaTeX_Fraktur-Regular.ttf) format("truetype")}@font-face{font-family:KaTeX_Main;font-style:normal;font-weight:700;src:url(fonts/KaTeX_Main-Bold.woff2) format("woff2"),url(fonts/KaTeX_Main-Bold.woff) format("woff"),url(fonts/KaTeX_Main-Bold.ttf) format("truetype")}@font-face{font-family:KaTeX_Main;font-style:italic;font-weight:700;src:url(fonts/KaTeX_Main-BoldItalic.woff2) format("woff2"),url(fonts/KaTeX_Main-BoldItalic.woff) format("woff"),url(fonts/KaTeX_Main-BoldItalic.ttf) format("truetype")}@font-face{font-family:KaTeX_Main;font-style:italic;font-weight:400;src:url(fonts/KaTeX_Main-Italic.woff2) format("woff2"),url(fonts/KaTeX_Main-Italic.woff) format("woff"),url(fonts/KaTeX_Main-Italic.ttf) format("truetype")}@font-face{font-family:KaTeX_Main;font-style:normal;font-weight:400;src:url(fonts/KaTeX_Main-Regular.woff2) format("woff2"),url(fonts/KaTeX_Main-Regular.woff) format("woff"),url(fonts/KaTeX_Main-Regular.ttf) format("truetype")}@font-face{font-family:KaTeX_Math;font-style:italic;font-weight:700;src:url(fonts/KaTeX_Math-BoldItalic.woff2) format("woff2"),url(fonts/KaTeX_Math-BoldItalic.woff) format("woff"),url(fonts/KaTeX_Math-BoldItalic.ttf) format("truetype")}@font-face{font-family:KaTeX_Math;font-style:italic;font-weight:400;src:url(fonts/KaTeX_Math-Italic.woff2) format("woff2"),url(fonts/KaTeX_Math-Italic.woff) format("woff"),url(fonts/KaTeX_Math-Italic.ttf) format("truetype")}@font-face{font-family:"KaTeX_SansSerif";font-style:normal;font-weight:700;src:url(fonts/KaTeX_SansSerif-Bold.woff2) format("woff2"),url(fonts/KaTeX_SansSerif-Bold.woff) format("woff"),url(fonts/KaTeX_SansSerif-Bold.ttf) format("truetype")}@font-face{font-family:"KaTeX_SansSerif";font-style:italic;font-weight:400;src:url(fonts/KaTeX_SansSerif-Italic.woff2) format("woff2"),url(fonts/KaTeX_SansSerif-Italic.woff) format("woff"),url(fonts/KaTeX_SansSerif-Italic.ttf) format("truetype")}@font-face{font-family:"KaTeX_SansSerif";font-style:normal;font-weight:400;src:url(fonts/KaTeX_SansSerif-Regular.woff2) format("woff2"),url(fonts/KaTeX_SansSerif-Regular.woff) format("woff"),url(fonts/KaTeX_SansSerif-Regular.ttf) format("truetype")}@font-face{font-family:KaTeX_Script;font-style:normal;font-weight:400;src:url(fonts/KaTeX_Script-Regular.woff2) format("woff2"),url(fonts/KaTeX_Script-Regular.woff) format("woff"),url(fonts/KaTeX_Script-Regular.ttf) format("truetype")}@font-face{font-family:KaTeX_Size1;font-style:normal;font-weight:400;src:url(fonts/KaTeX_Size1-Regular.woff2) format("woff2"),url(fonts/KaTeX_Size1-Regular.woff) format("woff"),url(fonts/KaTeX_Size1-Regular.ttf) format("truetype")}@font-face{font-family:KaTeX_Size2;font-style:normal;font-weight:400;src:url(fonts/KaTeX_Size2-Regular.woff2) format("woff2"),url(fonts/KaTeX_Size2-Regular.woff) format("woff"),url(fonts/KaTeX_Size2-Regular.ttf) format("truetype")}@font-face{font-family:KaTeX_Size3;font-style:normal;font-weight:400;src:url(fonts/KaTeX_Size3-Regular.woff2) format("woff2"),url(fonts/KaTeX_Size3-Regular.woff) format("woff"),url(fonts/KaTeX_Size3-Regular.ttf) format("truetype")}@font-face{font-family:KaTeX_Size4;font-style:normal;font-weight:400;src:url(fonts/KaTeX_Size4-Regular.woff2) format("woff2"),url(fonts/KaTeX_Size4-Regular.woff) format("woff"),url(fonts/KaTeX_Size4-Regular.ttf) format("truetype")}@font-face{font-family:KaTeX_Typewriter;font-style:normal;font-weight:400;src:url(fonts/KaTeX_Typewriter-Regular.woff2) format("woff2"),url(fonts/KaTeX_Typewriter-Regular.woff) format("woff"),url(fonts/KaTeX_Typewriter-Regular.ttf) format("truetype")}.katex{text-rendering:auto;font:normal 1.21em KaTeX_Main,Times New Roman,serif;line-height:1.2;text-indent:0}.katex *{-ms-high-contrast-adjust:none!important;border-color:currentColor}.katex .katex-version:after{content:"0.13.24"}.katex .katex-mathml{clip:rect(1px,1px,1px,1px);border:0;height:1px;overflow:hidden;padding:0;position:absolute;width:1px}.katex .katex-html>.newline{display:block}.katex .base{position:relative;white-space:nowrap;width:-webkit-min-content;width:-moz-min-content;width:min-content}.katex .base,.katex .strut{display:inline-block}.katex .textbf{font-weight:700}.katex .textit{font-style:italic}.katex .textrm{font-family:KaTeX_Main}.katex .textsf{font-family:KaTeX_SansSerif}.katex .texttt{font-family:KaTeX_Typewriter}.katex .mathnormal{font-family:KaTeX_Math;font-style:italic}.katex .mathit{font-family:KaTeX_Main;font-style:italic}.katex .mathrm{font-style:normal}.katex .mathbf{font-family:KaTeX_Main;font-weight:700}.katex .boldsymbol{font-family:KaTeX_Math;font-style:italic;font-weight:700}.katex .amsrm,.katex .mathbb,.katex .textbb{font-family:KaTeX_AMS}.katex .mathcal{font-family:KaTeX_Caligraphic}.katex .mathfrak,.katex .textfrak{font-family:KaTeX_Fraktur}.katex .mathtt{font-family:KaTeX_Typewriter}.katex .mathscr,.katex .textscr{font-family:KaTeX_Script}.katex .mathsf,.katex .textsf{font-family:KaTeX_SansSerif}.katex .mathboldsf,.katex .textboldsf{font-family:KaTeX_SansSerif;font-weight:700}.katex .mathitsf,.katex .textitsf{font-family:KaTeX_SansSerif;font-style:italic}.katex .mainrm{font-family:KaTeX_Main;font-style:normal}.katex .vlist-t{border-collapse:collapse;display:inline-table;table-layout:fixed}.katex .vlist-r{display:table-row}.katex .vlist{display:table-cell;position:relative;vertical-align:bottom}.katex .vlist>span{display:block;height:0;position:relative}.katex .vlist>span>span{display:inline-block}.katex .vlist>span>.pstrut{overflow:hidden;width:0}.katex .vlist-t2{margin-right:-2px}.katex .vlist-s{display:table-cell;font-size:1px;min-width:2px;vertical-align:bottom;width:2px}.katex .vbox{align-items:baseline;display:inline-flex;flex-direction:column}.katex .hbox{width:100%}.katex .hbox,.katex .thinbox{display:inline-flex;flex-direction:row}.katex .thinbox{max-width:0;width:0}.katex .msupsub{text-align:left}.katex .mfrac>span>span{text-align:center}.katex .mfrac .frac-line{border-bottom-style:solid;display:inline-block;width:100%}.katex .hdashline,.katex .hline,.katex .mfrac .frac-line,.katex .overline .overline-line,.katex .rule,.katex .underline .underline-line{min-height:1px}.katex .mspace{display:inline-block}.katex .clap,.katex .llap,.katex .rlap{position:relative;width:0}.katex .clap>.inner,.katex .llap>.inner,.katex .rlap>.inner{position:absolute}.katex .clap>.fix,.katex .llap>.fix,.katex .rlap>.fix{display:inline-block}.katex .llap>.inner{right:0}.katex .clap>.inner,.katex .rlap>.inner{left:0}.katex .clap>.inner>span{margin-left:-50%;margin-right:50%}.katex .rule{border:0 solid;display:inline-block;position:relative}.katex .hline,.katex .overline .overline-line,.katex .underline .underline-line{border-bottom-style:solid;display:inline-block;width:100%}.katex .hdashline{border-bottom-style:dashed;display:inline-block;width:100%}.katex .sqrt>.root{margin-left:.27777778em;margin-right:-.55555556em}.katex .fontsize-ensurer.reset-size1.size1,.katex .sizing.reset-size1.size1{font-size:1em}.katex .fontsize-ensurer.reset-size1.size2,.katex .sizing.reset-size1.size2{font-size:1.2em}.katex .fontsize-ensurer.reset-size1.size3,.katex .sizing.reset-size1.size3{font-size:1.4em}.katex .fontsize-ensurer.reset-size1.size4,.katex .sizing.reset-size1.size4{font-size:1.6em}.katex .fontsize-ensurer.reset-size1.size5,.katex .sizing.reset-size1.size5{font-size:1.8em}.katex .fontsize-ensurer.reset-size1.size6,.katex .sizing.reset-size1.size6{font-size:2em}.katex .fontsize-ensurer.reset-size1.size7,.katex .sizing.reset-size1.size7{font-size:2.4em}.katex .fontsize-ensurer.reset-size1.size8,.katex .sizing.reset-size1.size8{font-size:2.88em}.katex .fontsize-ensurer.reset-size1.size9,.katex .sizing.reset-size1.size9{font-size:3.456em}.katex .fontsize-ensurer.reset-size1.size10,.katex .sizing.reset-size1.size10{font-size:4.148em}.katex .fontsize-ensurer.reset-size1.size11,.katex .sizing.reset-size1.size11{font-size:4.976em}.katex .fontsize-ensurer.reset-size2.size1,.katex .sizing.reset-size2.size1{font-size:.83333333em}.katex .fontsize-ensurer.reset-size2.size2,.katex .sizing.reset-size2.size2{font-size:1em}.katex .fontsize-ensurer.reset-size2.size3,.katex .sizing.reset-size2.size3{font-size:1.16666667em}.katex .fontsize-ensurer.reset-size2.size4,.katex .sizing.reset-size2.size4{font-size:1.33333333em}.katex .fontsize-ensurer.reset-size2.size5,.katex .sizing.reset-size2.size5{font-size:1.5em}.katex .fontsize-ensurer.reset-size2.size6,.katex .sizing.reset-size2.size6{font-size:1.66666667em}.katex .fontsize-ensurer.reset-size2.size7,.katex .sizing.reset-size2.size7{font-size:2em}.katex .fontsize-ensurer.reset-size2.size8,.katex .sizing.reset-size2.size8{font-size:2.4em}.katex .fontsize-ensurer.reset-size2.size9,.katex .sizing.reset-size2.size9{font-size:2.88em}.katex .fontsize-ensurer.reset-size2.size10,.katex .sizing.reset-size2.size10{font-size:3.45666667em}.katex .fontsize-ensurer.reset-size2.size11,.katex .sizing.reset-size2.size11{font-size:4.14666667em}.katex .fontsize-ensurer.reset-size3.size1,.katex .sizing.reset-size3.size1{font-size:.71428571em}.katex .fontsize-ensurer.reset-size3.size2,.katex .sizing.reset-size3.size2{font-size:.85714286em}.katex .fontsize-ensurer.reset-size3.size3,.katex .sizing.reset-size3.size3{font-size:1em}.katex .fontsize-ensurer.reset-size3.size4,.katex .sizing.reset-size3.size4{font-size:1.14285714em}.katex .fontsize-ensurer.reset-size3.size5,.katex .sizing.reset-size3.size5{font-size:1.28571429em}.katex .fontsize-ensurer.reset-size3.size6,.katex .sizing.reset-size3.size6{font-size:1.42857143em}.katex .fontsize-ensurer.reset-size3.size7,.katex .sizing.reset-size3.size7{font-size:1.71428571em}.katex .fontsize-ensurer.reset-size3.size8,.katex .sizing.reset-size3.size8{font-size:2.05714286em}.katex .fontsize-ensurer.reset-size3.size9,.katex .sizing.reset-size3.size9{font-size:2.46857143em}.katex .fontsize-ensurer.reset-size3.size10,.katex .sizing.reset-size3.size10{font-size:2.96285714em}.katex .fontsize-ensurer.reset-size3.size11,.katex .sizing.reset-size3.size11{font-size:3.55428571em}.katex .fontsize-ensurer.reset-size4.size1,.katex .sizing.reset-size4.size1{font-size:.625em}.katex .fontsize-ensurer.reset-size4.size2,.katex .sizing.reset-size4.size2{font-size:.75em}.katex .fontsize-ensurer.reset-size4.size3,.katex .sizing.reset-size4.size3{font-size:.875em}.katex .fontsize-ensurer.reset-size4.size4,.katex .sizing.reset-size4.size4{font-size:1em}.katex .fontsize-ensurer.reset-size4.size5,.katex .sizing.reset-size4.size5{font-size:1.125em}.katex .fontsize-ensurer.reset-size4.size6,.katex .sizing.reset-size4.size6{font-size:1.25em}.katex .fontsize-ensurer.reset-size4.size7,.katex .sizing.reset-size4.size7{font-size:1.5em}.katex .fontsize-ensurer.reset-size4.size8,.katex .sizing.reset-size4.size8{font-size:1.8em}.katex .fontsize-ensurer.reset-size4.size9,.katex .sizing.reset-size4.size9{font-size:2.16em}.katex .fontsize-ensurer.reset-size4.size10,.katex .sizing.reset-size4.size10{font-size:2.5925em}.katex .fontsize-ensurer.reset-size4.size11,.katex .sizing.reset-size4.size11{font-size:3.11em}.katex .fontsize-ensurer.reset-size5.size1,.katex .sizing.reset-size5.size1{font-size:.55555556em}.katex .fontsize-ensurer.reset-size5.size2,.katex .sizing.reset-size5.size2{font-size:.66666667em}.katex .fontsize-ensurer.reset-size5.size3,.katex .sizing.reset-size5.size3{font-size:.77777778em}.katex .fontsize-ensurer.reset-size5.size4,.katex .sizing.reset-size5.size4{font-size:.88888889em}.katex .fontsize-ensurer.reset-size5.size5,.katex .sizing.reset-size5.size5{font-size:1em}.katex .fontsize-ensurer.reset-size5.size6,.katex .sizing.reset-size5.size6{font-size:1.11111111em}.katex .fontsize-ensurer.reset-size5.size7,.katex .sizing.reset-size5.size7{font-size:1.33333333em}.katex .fontsize-ensurer.reset-size5.size8,.katex .sizing.reset-size5.size8{font-size:1.6em}.katex .fontsize-ensurer.reset-size5.size9,.katex .sizing.reset-size5.size9{font-size:1.92em}.katex .fontsize-ensurer.reset-size5.size10,.katex .sizing.reset-size5.size10{font-size:2.30444444em}.katex .fontsize-ensurer.reset-size5.size11,.katex .sizing.reset-size5.size11{font-size:2.76444444em}.katex .fontsize-ensurer.reset-size6.size1,.katex .sizing.reset-size6.size1{font-size:.5em}.katex .fontsize-ensurer.reset-size6.size2,.katex .sizing.reset-size6.size2{font-size:.6em}.katex .fontsize-ensurer.reset-size6.size3,.katex .sizing.reset-size6.size3{font-size:.7em}.katex .fontsize-ensurer.reset-size6.size4,.katex .sizing.reset-size6.size4{font-size:.8em}.katex .fontsize-ensurer.reset-size6.size5,.katex .sizing.reset-size6.size5{font-size:.9em}.katex .fontsize-ensurer.reset-size6.size6,.katex .sizing.reset-size6.size6{font-size:1em}.katex .fontsize-ensurer.reset-size6.size7,.katex .sizing.reset-size6.size7{font-size:1.2em}.katex .fontsize-ensurer.reset-size6.size8,.katex .sizing.reset-size6.size8{font-size:1.44em}.katex .fontsize-ensurer.reset-size6.size9,.katex .sizing.reset-size6.size9{font-size:1.728em}.katex .fontsize-ensurer.reset-size6.size10,.katex .sizing.reset-size6.size10{font-size:2.074em}.katex .fontsize-ensurer.reset-size6.size11,.katex .sizing.reset-size6.size11{font-size:2.488em}.katex .fontsize-ensurer.reset-size7.size1,.katex .sizing.reset-size7.size1{font-size:.41666667em}.katex .fontsize-ensurer.reset-size7.size2,.katex .sizing.reset-size7.size2{font-size:.5em}.katex .fontsize-ensurer.reset-size7.size3,.katex .sizing.reset-size7.size3{font-size:.58333333em}.katex .fontsize-ensurer.reset-size7.size4,.katex .sizing.reset-size7.size4{font-size:.66666667em}.katex .fontsize-ensurer.reset-size7.size5,.katex .sizing.reset-size7.size5{font-size:.75em}.katex .fontsize-ensurer.reset-size7.size6,.katex .sizing.reset-size7.size6{font-size:.83333333em}.katex .fontsize-ensurer.reset-size7.size7,.katex .sizing.reset-size7.size7{font-size:1em}.katex .fontsize-ensurer.reset-size7.size8,.katex .sizing.reset-size7.size8{font-size:1.2em}.katex .fontsize-ensurer.reset-size7.size9,.katex .sizing.reset-size7.size9{font-size:1.44em}.katex .fontsize-ensurer.reset-size7.size10,.katex .sizing.reset-size7.size10{font-size:1.72833333em}.katex .fontsize-ensurer.reset-size7.size11,.katex .sizing.reset-size7.size11{font-size:2.07333333em}.katex .fontsize-ensurer.reset-size8.size1,.katex .sizing.reset-size8.size1{font-size:.34722222em}.katex .fontsize-ensurer.reset-size8.size2,.katex .sizing.reset-size8.size2{font-size:.41666667em}.katex .fontsize-ensurer.reset-size8.size3,.katex .sizing.reset-size8.size3{font-size:.48611111em}.katex .fontsize-ensurer.reset-size8.size4,.katex .sizing.reset-size8.size4{font-size:.55555556em}.katex .fontsize-ensurer.reset-size8.size5,.katex .sizing.reset-size8.size5{font-size:.625em}.katex .fontsize-ensurer.reset-size8.size6,.katex .sizing.reset-size8.size6{font-size:.69444444em}.katex .fontsize-ensurer.reset-size8.size7,.katex .sizing.reset-size8.size7{font-size:.83333333em}.katex .fontsize-ensurer.reset-size8.size8,.katex .sizing.reset-size8.size8{font-size:1em}.katex .fontsize-ensurer.reset-size8.size9,.katex .sizing.reset-size8.size9{font-size:1.2em}.katex .fontsize-ensurer.reset-size8.size10,.katex .sizing.reset-size8.size10{font-size:1.44027778em}.katex .fontsize-ensurer.reset-size8.size11,.katex .sizing.reset-size8.size11{font-size:1.72777778em}.katex .fontsize-ensurer.reset-size9.size1,.katex .sizing.reset-size9.size1{font-size:.28935185em}.katex .fontsize-ensurer.reset-size9.size2,.katex .sizing.reset-size9.size2{font-size:.34722222em}.katex .fontsize-ensurer.reset-size9.size3,.katex .sizing.reset-size9.size3{font-size:.40509259em}.katex .fontsize-ensurer.reset-size9.size4,.katex .sizing.reset-size9.size4{font-size:.46296296em}.katex .fontsize-ensurer.reset-size9.size5,.katex .sizing.reset-size9.size5{font-size:.52083333em}.katex .fontsize-ensurer.reset-size9.size6,.katex .sizing.reset-size9.size6{font-size:.5787037em}.katex .fontsize-ensurer.reset-size9.size7,.katex .sizing.reset-size9.size7{font-size:.69444444em}.katex .fontsize-ensurer.reset-size9.size8,.katex .sizing.reset-size9.size8{font-size:.83333333em}.katex .fontsize-ensurer.reset-size9.size9,.katex .sizing.reset-size9.size9{font-size:1em}.katex .fontsize-ensurer.reset-size9.size10,.katex .sizing.reset-size9.size10{font-size:1.20023148em}.katex .fontsize-ensurer.reset-size9.size11,.katex .sizing.reset-size9.size11{font-size:1.43981481em}.katex .fontsize-ensurer.reset-size10.size1,.katex .sizing.reset-size10.size1{font-size:.24108004em}.katex .fontsize-ensurer.reset-size10.size2,.katex .sizing.reset-size10.size2{font-size:.28929605em}.katex .fontsize-ensurer.reset-size10.size3,.katex .sizing.reset-size10.size3{font-size:.33751205em}.katex .fontsize-ensurer.reset-size10.size4,.katex .sizing.reset-size10.size4{font-size:.38572806em}.katex .fontsize-ensurer.reset-size10.size5,.katex .sizing.reset-size10.size5{font-size:.43394407em}.katex .fontsize-ensurer.reset-size10.size6,.katex .sizing.reset-size10.size6{font-size:.48216008em}.katex .fontsize-ensurer.reset-size10.size7,.katex .sizing.reset-size10.size7{font-size:.57859209em}.katex .fontsize-ensurer.reset-size10.size8,.katex .sizing.reset-size10.size8{font-size:.69431051em}.katex .fontsize-ensurer.reset-size10.size9,.katex .sizing.reset-size10.size9{font-size:.83317261em}.katex .fontsize-ensurer.reset-size10.size10,.katex .sizing.reset-size10.size10{font-size:1em}.katex .fontsize-ensurer.reset-size10.size11,.katex .sizing.reset-size10.size11{font-size:1.19961427em}.katex .fontsize-ensurer.reset-size11.size1,.katex .sizing.reset-size11.size1{font-size:.20096463em}.katex .fontsize-ensurer.reset-size11.size2,.katex .sizing.reset-size11.size2{font-size:.24115756em}.katex .fontsize-ensurer.reset-size11.size3,.katex .sizing.reset-size11.size3{font-size:.28135048em}.katex .fontsize-ensurer.reset-size11.size4,.katex .sizing.reset-size11.size4{font-size:.32154341em}.katex .fontsize-ensurer.reset-size11.size5,.katex .sizing.reset-size11.size5{font-size:.36173633em}.katex .fontsize-ensurer.reset-size11.size6,.katex .sizing.reset-size11.size6{font-size:.40192926em}.katex .fontsize-ensurer.reset-size11.size7,.katex .sizing.reset-size11.size7{font-size:.48231511em}.katex .fontsize-ensurer.reset-size11.size8,.katex .sizing.reset-size11.size8{font-size:.57877814em}.katex .fontsize-ensurer.reset-size11.size9,.katex .sizing.reset-size11.size9{font-size:.69453376em}.katex .fontsize-ensurer.reset-size11.size10,.katex .sizing.reset-size11.size10{font-size:.83360129em}.katex .fontsize-ensurer.reset-size11.size11,.katex .sizing.reset-size11.size11{font-size:1em}.katex .delimsizing.size1{font-family:KaTeX_Size1}.katex .delimsizing.size2{font-family:KaTeX_Size2}.katex .delimsizing.size3{font-family:KaTeX_Size3}.katex .delimsizing.size4{font-family:KaTeX_Size4}.katex .delimsizing.mult .delim-size1>span{font-family:KaTeX_Size1}.katex .delimsizing.mult .delim-size4>span{font-family:KaTeX_Size4}.katex .nulldelimiter{display:inline-block;width:.12em}.katex .delimcenter,.katex .op-symbol{position:relative}.katex .op-symbol.small-op{font-family:KaTeX_Size1}.katex .op-symbol.large-op{font-family:KaTeX_Size2}.katex .accent>.vlist-t,.katex .op-limits>.vlist-t{text-align:center}.katex .accent .accent-body{position:relative}.katex .accent .accent-body:not(.accent-full){width:0}.katex .overlay{display:block}.katex .mtable .vertical-separator{display:inline-block;min-width:1px}.katex .mtable .arraycolsep{display:inline-block}.katex .mtable .col-align-c>.vlist-t{text-align:center}.katex .mtable .col-align-l>.vlist-t{text-align:left}.katex .mtable .col-align-r>.vlist-t{text-align:right}.katex .svg-align{text-align:left}.katex svg{fill:currentColor;stroke:currentColor;fill-rule:nonzero;fill-opacity:1;stroke-width:1;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1;display:block;height:inherit;position:absolute;width:100%}.katex svg path{stroke:none}.katex img{border-style:none;max-height:none;max-width:none;min-height:0;min-width:0}.katex .stretchy{display:block;overflow:hidden;position:relative;width:100%}.katex .stretchy:after,.katex .stretchy:before{content:""}.katex .hide-tail{overflow:hidden;position:relative;width:100%}.katex .halfarrow-left{left:0;overflow:hidden;position:absolute;width:50.2%}.katex .halfarrow-right{overflow:hidden;position:absolute;right:0;width:50.2%}.katex .brace-left{left:0;overflow:hidden;position:absolute;width:25.1%}.katex .brace-center{left:25%;overflow:hidden;position:absolute;width:50%}.katex .brace-right{overflow:hidden;position:absolute;right:0;width:25.1%}.katex .x-arrow-pad{padding:0 .5em}.katex .cd-arrow-pad{padding:0 .55556em 0 .27778em}.katex .mover,.katex .munder,.katex .x-arrow{text-align:center}.katex .boxpad{padding:0 .3em}.katex .fbox,.katex .fcolorbox{border:.04em solid;box-sizing:border-box}.katex .cancel-pad{padding:0 .2em}.katex .cancel-lap{margin-left:-.2em;margin-right:-.2em}.katex .sout{border-bottom-style:solid;border-bottom-width:.08em}.katex .angl{border-right:.049em solid;border-top:.049em solid;box-sizing:border-box;margin-right:.03889em}.katex .anglpad{padding:0 .03889em}.katex .eqn-num:before{content:"(" counter(katexEqnNo) ")";counter-increment:katexEqnNo}.katex .mml-eqn-num:before{content:"(" counter(mmlEqnNo) ")";counter-increment:mmlEqnNo}.katex .mtr-glue{width:50%}.katex .cd-vert-arrow{display:inline-block;position:relative}.katex .cd-label-left{display:inline-block;position:absolute;right:calc(50% + .3em);text-align:left}.katex .cd-label-right{display:inline-block;left:calc(50% + .3em);position:absolute;text-align:right}.katex-display{display:block;margin:1em 0;text-align:center}.katex-display>.katex{display:block;text-align:center;white-space:nowrap}.katex-display>.katex>.katex-html{display:block;position:relative}.katex-display>.katex>.katex-html>.tag{position:absolute;right:0}.katex-display.leqno>.katex>.katex-html>.tag{left:0;right:auto}.katex-display.fleqn>.katex{padding-left:2em;text-align:left}body{counter-reset:katexEqnNo mmlEqnNo}

/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

.katex-error {
	color: var(--vscode-editorError-foreground);
}

</style>
        
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
<style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', system-ui, 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        <style>
.task-list-item { list-style-type: none; } .task-list-item-checkbox { margin-left: -20px; vertical-align: middle; }
</style>
        
    </head>
    <body class="vscode-body vscode-light">
        <ul>
<li><a href="#android-nfc">Android NFC</a>
<ul>
<li><a href="#%E5%9F%BA%E7%A1%80">基础</a></li>
<li><a href="#nfc%E7%9A%84%E5%90%AF%E7%94%A8">NFC的启用</a></li>
<li><a href="#nfc-rw%E6%A8%A1%E5%BC%8F%E7%9B%91%E5%90%AC%E7%9A%84%E5%90%AF%E7%94%A8">NFC R/W模式监听的启用</a></li>
<li><a href="#nfc-rw%E6%A8%A1%E5%BC%8F%E6%93%8D%E4%BD%9C%E7%9A%84%E5%BA%95%E5%B1%82%E5%88%9D%E5%A7%8B%E5%8C%96">NFC R/W模式操作的底层初始化</a></li>
<li><a href="#nfc-rw%E6%A8%A1%E5%BC%8F%E5%AF%B9%E8%AE%BE%E5%A4%87%E7%9A%84%E5%8F%91%E7%8E%B0">NFC R/W模式对设备的发现</a></li>
<li><a href="#nfc-rw%E6%A8%A1%E5%BC%8F%E4%B8%8B%E5%AF%B9msg_ndef_tag%E7%B1%BB%E5%9E%8B%E8%AE%BE%E5%A4%87%E7%9A%84%E5%A4%84%E7%90%86">NFC R/W模式下对<code>MSG_NDEF_TAG</code>类型设备的处理</a></li>
<li><a href="#nfc-rw%E6%A8%A1%E5%BC%8F%E4%B8%8A%E8%A1%8C%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B">NFC R/W模式上行数据流程</a></li>
</ul>
</li>
</ul>
<h1 id="android-nfc">Android NFC</h1>
<h2 id="基础">基础</h2>
<p>NFC服务<code>NfcService</code>运行于<code>com.android.nfc</code>进程之中, 其底层有很多层次结构.</p>
<p>NFC有多种工作方式:</p>
<ul>
<li>Reader/Write模式, 也就是读写模式</li>
<li>Peer-to-Peer模式, 也就是点对点模式</li>
<li>NFC Card Emulation模式, 也就是模拟卡模式</li>
</ul>
<p>这里主要讨论读写模式.</p>
<h2 id="nfc的启用">NFC的启用</h2>
<p>应用通过<code>INfcAdapter</code>接口的<code>enable()</code>函数启用NFC, 该消息将在<code>NfcAdapterService</code>中处理, 该调用发生后<code>NfcAdapterService</code>通过异步任务<code>EnableDisableTask</code>发送<code>TASK_ENABLE</code>消息给<code>NativeNfcManager</code>, 后者通过<code>initialize()</code>响应, 并执行native方法<code>doInitialize()</code>.</p>
<p><code>doInitialize()</code>本地方法定义对应<code>packages/apps/Nfc/nci/jni/NativeNfcManager.cpp</code>中的<code>nfcManager_doInitialize()</code>, 首先通过<code>NfcAdaptation::GetInstance()</code>获取<code>tHAL_NFC_ENTRY</code>, 然后通过<code>NFA_Init()</code>初始化<code>NFA</code>, 并将<code>tHAL_NFC_ENTRY</code>设置在全局的<code>nfc_cb.p_hal</code>. <code>NFA_Init()</code>其余各组建的初始化暂时略去.</p>
<p><code>NfcAdaptation::GetInstance()</code>时通过<code>NfcAdaptation::InitializeHalDeviceContext()</code>完成了初始化, 并且通过<code>[INfcV1_1|INfcV1_2]::getService()</code>获取了[INfcV1_1|INfcV1_1]接口, 并保存到[mHal_1_1|mHal_1_2]中.</p>
<p>接着<code>NativeNfcManager</code>通过<code>NFA_Enable()</code>启用NFC, 并注册了两个回调:</p>
<ul>
<li><code>nfaDeviceManagementCallback()</code>, 负责响应设备管理的消息, 例如设备发现</li>
<li><code>nfaConnectionCallback()</code>, 负责响应设备链接的消息, 然后通过<code>sNfaEnableEvent</code>等待底层处理完成NFC的启用.</li>
</ul>
<p>以上两个回调将被封装成一个NFC消息(其消息头的事件类型被标记为<code>NFA_DM_API_ENABLE_EVT</code>), 通过消息盒子走<code>GKI</code>发送给<code>nfc_task</code>线程统一处理.</p>
<p>在考虑<code>nfc_task</code>处理<code>DeviceManager</code>消息之前, 关注<code>NFA_Init()</code>中<code>nfa_dm_init()</code>的调用, 该方法初始化了全局的<code>nfa_dm_cb</code>, 注册了关键的回调:<code>tNFA_SYS_REG nfa_dm_sys_reg</code>, 该回调被注册掉全局的<code>nfa_sys_cb.reg[id]</code>中(此处的<code>id</code>显然是<code>NFA_ID_DM</code>), 该回调中的<code>evt_hdlr</code>方法(也就是<code>nfa_dm_evt_hdlr()</code>)负责根据具体的消息类型(例如上文提到的:<code>NFA_DM_API_ENABLE_EVT</code>)回调<code>nfa_dm_action[]</code>中相应的方法, 处理所有<code>NFA_DM_API_*</code>类型的消息.</p>
<p>接着看<code>nfc_task</code>是如何响应该消息的, <code>nfc_task</code>首先通过<code>GKI_Wait()</code>等待<code>NFA_MBOX_EVT_MASK</code>类型的消息, 然后通过<code>GKI_read_mbox()</code>读取消息内容交由<code>nfa_sys_event</code>处理, <code>nfa_sys_event()</code>则调用上文的<code>nfa_sys_cb.reg[id]-&gt;evt_hdlr</code>来处理, 此处自然是<code>nfa_dm_evt_hdlr()</code>(此时的id是<code>NFA_ID_DM</code>), 在根据此前的事件<code>NFA_DM_API_ENABLE_EVT</code>调用到<code>nfa_dm_action[]</code>中的<code>nfa_dm_enable()</code>, 注意此处:</p>
<ul>
<li>上文的<code>nfaDeviceManagementCallback()</code>被设置到了<code>nfa_dm_cb.p_dm_cback</code></li>
<li>上文的<code>nfaConnectionCallback()</code>被设置到了<code>nfa_dm_cb.p_conn_cback</code></li>
</ul>
<p><code>nfa_dm_enable()</code>继续调用<code>NFC_Enable()</code>启用NFC功能, 并传入<code>nfa_dm_nfc_response_cback()</code>回调, <code>nfa_dm_nfc_response_cback()</code>被保存到<code>nfc_cb.p_resp_cback</code>, 然后调用<code>nfc_cb.p_hal-&gt;open</code>打开<code>HAL</code>层, 并传入<code>nfc_main_hal_cback()</code>和<code>nfc_main_hal_data_cback()</code>两个回调.</p>
<p>此处的<code>tHAL_NFC_ENTRY</code>实际上是<code>NfcAdaptation::mHalEntryFuncs</code>, 该结构体已经在首次执行<code>NfcAdaptation::GetInstance()</code>时通过<code>NfcAdaptation::InitializeHalDeviceContext()</code>完成了初始化. 那此处的<code>open</code>对应的则是<code>HalOpen()</code>, 该函数将通过<code>[INfcV1_1|INfcV1_2]</code>对<code>HAL</code>层进行<code>open</code>操作, 并传入<code>NfcClientCallback()</code>(集成了接口<code>INfcClientCallback</code>)回调.</p>
<p>至此上文提到的<code>nfc_main_hal_cback()</code>和<code>nfc_main_hal_data_cback()</code>被分别保存在<code>NfcClientCallback</code>的<code>mEventCallback</code>和<code>mDataCallback</code>中:</p>
<ul>
<li>当<code>HAL</code>曾通过<code>INfcClientCallback</code>回调<code>sendEvent[_1_1]()</code>接口时, <code>nfc_main_hal_cback()</code>被回调</li>
<li>当<code>HAL</code>曾通过<code>INfcClientCallback</code>回调<code>sendData()</code>接口时, <code>nfc_main_hal_data_cback()</code>被回调</li>
</ul>
<p>那么什么时候通过<code>nfc_cb.p_resp_cback</code>回调<code>nfa_dm_nfc_response_cback()</code>呢? <code>nfc_main_hal_cback()</code>通过<code>NfcClientCallback::sendEvent[_1_1]()</code>被调用, 如果<code>nfc_main_hal_cback()</code>收到<code>HAL_NFC_OPEN_CPLT_EVT</code>表示打开成功的事件, 则通过<code>nfc_main_post_hal_evt()</code>发消息个<code>nfc_task</code>, 消息类型是<code>BT_EVT_TO_NFC_MSGS</code>(底层NFC消息, 掩码是<code>NFC_EVT_MASK</code>), 然后<code>nfc_task</code>调用<code>nfc_main_handle_hal_evt()</code>检查<code>tNFC_HAL_EVT_MSG.hal_evt</code>, 如果是<code>HAL_NFC_POST_INIT_CPLT_EVT</code>, 则调用<code>nfc_enabled()</code>进行部分工作后调用<code>nfc_main_notify_enable_status()</code>(参数是<code>NCI_STATUS_OK</code>)向上通知事件, 次过程将回调上文保存的<code>nfc_cb.p_resp_cback</code>(也就是<code>nfa_dm_nfc_response_cback()</code>), 并传递<code>NFC_ENABLE_REVT</code>参数. 然后<code>nfa_dm_nfc_response_cback()</code>继续回调<code>nfa_dm_cb.p_dm_cback</code>, 这里的<code>nfa_dm_cb.p_dm_cback</code>是上文的<code>nfaDeviceManagementCallback()</code>, 参数是<code>NFA_DM_ENABLE_EVT</code>, 这里可以看到通过<code>sNfaEnableEvent</code>, 通知了<code>nfcManager_doInitialize()</code></p>
<h2 id="nfc-rw模式监听的启用">NFC R/W模式监听的启用</h2>
<p><code>NfcService</code>通过<code>BroadcastReceiver</code>监听亮屏广播<code>ACTION_SCREEN_ON</code>, 然后通过异步任务<code>ApplyRoutingTask</code>执行设备发现的启用和关闭. 这里假设亮屏, <code>AppleRoutingTask.doInBackground()</code>的参数为<code>true</code>, 进一步<code>NativeNfcManager.enableDiscovery()</code>被调用, 其调用本地方法<code>doEnableDiscovery()</code>, 对应<code>packages/apps/Nfc/nci/jni/NativeNfcManager.cpp</code>中的<code>nfcManager_enableDiscovery()</code>, 此时<code>tech_mask</code>不为空, 因此<code>startPolling_rfDiscoveryDisabled()</code>被调用, 进一步<code>NFA_EnablePolling()</code>也被调用, 此时向<code>nfc_task</code>发出<code>NFA_DM_API_ENABLE_POLLING_EVT</code>消息.</p>
<p>上述<code>NFA_DM_API_ENABLE_POLLING_EVT</code>消息被<code>nfa_dm_action[]</code>中的<code>nfa_dm_act_enable_polling()</code>响应, 最后<code>nfa_dm_start_polling()</code>被调用. <code>nfa_dm_poll_disc_cback()</code>被保存在<code>nfa_dm_cb.disc_cb.entry[xx].p_disc_cback</code>用于响应发现设备事件.</p>
<p>回到<code>nfcManager_enableDiscovery()</code>该方法最后调用了<code>startRfDiscovery()</code>, 向<code>nfc_task</code>发出了<code>NFA_DM_API_START_RF_DISCOVERY_EVT</code>消息, 该消息最终由<code>nfa_dm_action[]</code>中的<code>nfa_dm_act_start_rf_discovery()</code>处理, 该方法通过<code>nfa_dm_start_rf_discover()</code>分别调用了:</p>
<ul>
<li><code>NFC_DiscoveryStart()</code>: 负责将<code>nfa_dm_disc_discovery_cback()</code>设置到了<code>nfc_cb.p_discv_cback</code></li>
<li><code>NFC_SetStaticRfCback()</code>: 负责将<code>nfa_dm_disc_data_cback()</code>设置到了<code>&amp;nfc_cb.conn_cb[NFC_RF_CONN_ID]-&gt;p_cback</code></li>
</ul>
<h2 id="nfc-rw模式操作的底层初始化">NFC R/W模式操作的底层初始化</h2>
<p>在开始探寻NFC设备发现之前, 我们可以先假设, NFC将链接的设备是标签设备, 关注在<code>NFA_Init()</code>中, 对<code>nfa_rw_init()</code>的调用, 注册了<code>NFA_ID_RW</code>的响应:<code>tNFA_SYS_REG nfa_rw_sys_reg</code>, 其中<code>nfa_rw_sys_reg</code>的<code>evb_hdlr</code>为<code>nfa_rw_handle_event()</code>, 其将通过<code>tNFA_RW_ACTION nfa_rw_action_tbl[]</code>处理所有的<code>NFA_RW_*</code>消息</p>
<h2 id="nfc-rw模式对设备的发现">NFC R/W模式对设备的发现</h2>
<p>如果有HAL通过底层驱动发现了新设备, 则上文的<code>nfc_main_hal_data_cback()</code>被调用, 此时想<code>nfc_task</code>发出<code>BT_EVT_TO_NFC_NCI</code>消息, 而<code>nfc_task</code>调用首先判定收到的消息类型为<code>NCI_MT_RSP</code>, 然后进一步判断并通过<code>nci_proc_rf_management_ntf()</code>处理<code>gid</code>为<code>NCI_GID_RF_MANAGE</code>的消息(底层发出), 进一步判断<code>HAL</code>层消息的操作码<code>op_code</code>, 如果是发现设别则为<code>NCI_MSG_RF_INTF_ACTIVATED</code>, 因此<code>nfc_ncif_proc_discover_ntf()</code>被调用, 在处理完成数据后, 调用<code>nfc_cb.p_discv_cback</code>, 也就是<code>nfa_dm_disc_discovery_cback()</code>进一步处理, 显然, 此时的消息类型是<code>NFC_ACTIVATE_DEVT</code>.</p>
<p><code>nfa_dm_disc_discovery_cback()</code>收到<code>NFC_ACTIVATE_DEVT</code>后调传递发现设备消息<code>NFA_DM_RF_INTF_ACTIVATED_NTF</code>给<code>nfa_dm_disc_sm_execute()</code>, 后者检查<code>nfa_dm_cb.disc_cb.disc_state</code>的值, 此时为<code>NFA_DM_RFST_DISCOVERY</code>, 因此调用<code>nfa_dm_disc_sm_discovery()</code>, 后者根据事件类型<code>NFA_DM_RF_INTF_ACTIVATED_NTF</code>调用<code>nfa_dm_disc_notify_activation()</code>, 最终通过<code>nfa_dm_cb.disc_cb.entry[xx].p_disc_cback</code>调用到<code>nfa_dm_poll_disc_cback()</code>并继续传递事件<code>NFA_DM_RF_DISC_ACTIVATED_EVT</code>.</p>
<p><code>nfa_dm_poll_disc_cback()</code>通过事件类型<code>NFA_DM_RF_DISC_ACTIVATED_EVT</code>调用<code>nfa_rw_proc_disc_evt()</code>并传递事件<code>NFA_DM_RF_DISC_ACTIVATED_EVT</code>, 最终根据<code>NFA_RW_ACTIVATE_NTF_EVT</code>通过<code>nfa_rw_handle_event()</code>调用<code>nfa_rw_action_tbl[]</code>中的<code>nfa_rw_activate_ntf()</code>方法. 这里可以注意下, 不是通过<code>tNFA_SYS_REG nfa_rw_sys_reg</code>调用过来的.</p>
<p><code>nfa_rw_activate_ntf()</code>通过<code>RW_SetActivatedTagType()</code>根据协议(这里是<code>NFC_PROTOCOL_T2T</code>)执行了连个操作:</p>
<ul>
<li>将<code>nfa_rw_cback()</code>设置给了<code>rw_cb.p_cback</code></li>
<li>调用<code>rw_t2t_select()</code>, 后者通过<code>NFC_SetStaticRfCback()</code>将<code>p_cb-&gt;p_cback</code>设置成了<code>rw_t2t_conn_cback()</code>以供后续有上行数据上来时调用.</li>
</ul>
<p><code>nfa_rw_activate_ntf()</code>处理完成后会调用<code>nfa_dm_notify_activation_status()</code>, 而后者继续调用<code>nfa_dm_notify_activation_status()</code>并传递<code>NFA_ACTIVATED_EVT</code>事件, 最终通过<code>nfa_dm_cb.p_conn_cback</code>调用到上文设置的<code>nfaConnectionCallback()</code>, 此时由于不是点对点传输方式, 因此<code>NfcTag::connectionEventHandler()</code>被调用, 事件<code>NFA_ACTIVATED_EVT</code>被继续传递, 最终通过<code>NfcTag::createNativeNfcTag()</code>完成对<code>NativeNfcTag</code>的创建, 并完成一系列信息的设置.</p>
<p>最终通过<code>gCachedNfcManagerNotifyNdefMessageListeners()</code>回调Java层的<code>NativNfcManager.notifyNdefMessageListeners()</code>, 此时<code>NativeNfcManager</code>调用监听者<code>DeviceHostListener</code>的<code>onRemoteEndpointDiscovered()</code>接口, 此处<code>DeviceHostListener</code>的实现是<code>NfcService</code>, 因此<code>NfcService.onRemoteEndpointDiscovered()</code>被调用.</p>
<p><code>NfcService</code>在被底层通知有新的<code>TagEndpoint</code>(实现为<code>NativeNfcTag</code>)时, 直接发出了个<code>NfcService.MSG_NDEF_TAG</code>的异步消息, 这个消息会被<code>NfcServiceHandler</code>响应, 并进行接下来的判断.</p>
<h2 id="nfc-rw模式下对msg_ndef_tag类型设备的处理">NFC R/W模式下对<code>MSG_NDEF_TAG</code>类型设备的处理</h2>
<p><code>NfcService</code>首先通过<code>NativeNfcTag.findAndReadNdef()</code>读取<code>NDEF</code>信息, 对于<code>NativeNfcTag</code>后续的调用分别为<code>readNdef()</code>和<code>doRead()</code>, 其中<code>doRead()</code>是个本地方法, 对应的是<code>packages/apps/Nfc/nci/jni/NativeNfcTag.cpp</code>中的<code>nativeNfcTag_doRead()</code>方法, 其通过<code>NFA_RwReadNDef()</code>发送<code>NFA_RW_OP_REQUEST_EVT</code>消息给<code>nfc_task</code>, 操作类型为<code>NFA_RW_OP_READ_NDEF</code>. 该方法发送完消息后, 通过<code>sReadEvent</code>等待读取事务的完成.</p>
<p><code>nfc_task</code>收到消息后, 首先判断其类型为: <code>NFA_ID_RW</code>, 然后在<code>nfa_sys_event()</code>中通过<code>nfa_sys_cb.reg[NFA_ID_RW]-&gt;evt_hdlr</code>调用到<code>nfa_rw_sys_reg</code>中的<code>nfa_rw_handle_event()</code>, 而后者通过之前的<code>NFA_RW_OP_REQUEST_EVT</code>消息调用到<code>nfa_rw_action_tbl[]</code>中的<code>nfa_rw_handle_op_req()</code>.</p>
<p>上文说过操作是<code>NFA_RW_OP_READ_NDEF</code>, 因此<code>nfa_rw_handle_op_req()</code>继续调用<code>nfa_rw_read_ndef()</code>读取<code>NDEF</code>信息, 进一步调用<code>nfa_rw_start_ndef_read()</code>, 此时需要判断设备的协议类型, 如果是<code>NFC_PROTOCOL_T2T</code>, 则调用<code>RW_T2tReadNDef()</code>, 而后者继续调用<code>rw_t2t_read()</code>发起读取操作. 该函数准备参数, 继续调用<code>rw_t2t_send_cmd()</code>执行发送, 操作码为<code>T2T_CMD_READ</code>, 发送的过程通过<code>NFC_SendData()</code>(<code>conn_id</code>为<code>NFC_RF_CONN_ID</code>)调用<code>nfc_ncif_send_data()</code>完成.</p>
<p><code>nfc_ncif_send_data()</code>通过<code>HAL_WRITE()</code>(也就是<code>nfc_cb.p_hal-&gt;write</code>)完成数据的<code>HAL</code>层的写入, 这里显然是<code>system/nfc/src/adaptation/NfcAdaptation.cc:HalWrite()</code>, <code>NfcAdaptation</code>继续通过<code>INfcAidl::write()</code>接口通过<code>Binder</code>执行发送操作.</p>
<h2 id="nfc-rw模式上行数据流程">NFC R/W模式上行数据流程</h2>
<p>上文说过, <code>HAL</code>层有数据会回调<code>nfc_main_hal_data_cback()</code>, 该函数向<code>nfc_task</code>发出<code>BT_EVT_TO_NFC_NCI</code>消息, 而<code>nfc_task</code>通过<code>nfc_ncif_process_event()</code>响应, 如果是设备回复数据, 则消息类型为<code>NCI_MT_DATA</code>, 对应的处理函数为<code>nfc_ncif_proc_data()</code>, 读取到数据后, 进一步调用<code>nfc_data_event()</code>, 该函数通过<code>p_cb-&gt;p_cback</code>通知上层, 根据上文的内容, 此处在<code>rw_t2t_select()</code>中被<code>NFC_SetStaticRfCback()</code>设置为<code>rw_t2t_conn_cback()</code>, 该方法被调用是, 传递了事件<code>NFC_DATA_CEVT</code>, 因此<code>rw_t2t_proc_data()</code>被调用, 进一步的<code>rw_t2t_handle_rsp()</code>被调用, 然后开始检查<code>p_t2t-&gt;state</code>的值, 此情形下是<code>RW_T2T_STATE_READ_NDEF</code>, 因此调用<code>rw_t2t_handle_ndef_read_rsp()</code>, 该函数回调<code>rw_cb.p_cback</code>(此处为<code>nfa_rw_cback()</code>)并传入参数事件<code>RW_T2T_NDEF_READ_EVT</code>, <code>nfa_rw_cback()</code>在协议为<code>NFC_PROTOCOL_T2T</code>时调用<code>nfa_rw_handle_t2t_evt()</code>.</p>
<p><code>nfa_rw_handle_t2t_evt()</code>先处理<code>RW_T2T_NDEF_READ_EVT</code>消息, 然后调用<code>nfa_dm_act_conn_cback_notify()</code>通知上层, 通知的事件是<code>NFA_READ_CPLT_EVT</code>, 进一步通过<code>nfa_dm_conn_cback_event_notify()</code>回调上文讲到的<code>nfa_dm_cb.p_conn_cback</code>所指向的<code>nfaConnectionCallback()</code>, 该回调调用<code>nativeNfcTag_doReadCompleted()</code>, 后者通过<code>sReadEvent</code>发送消息给<code>nativeNfcTag_doRead()</code>方法使其返回.</p>

        
        
    </body>
    </html>